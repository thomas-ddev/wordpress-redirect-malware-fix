<?php

/*
 * Author: thomas-ddev
 * Date: 16 sept. 2021
 * URL: https://github.com/thomas-ddev/
 * Description: Auto update the website's URL & flush server's cache
 */

require('wp-load.php');

// Database config
$dbHost = "localhost";
$dbUser = "username";
$dbPass = "password";
$dbName = "db-name";

// WordPress config
$dbPrefix = "wp_";
$correctUrl = "https://website.com";

// PDO connection
$db = new PDO('mysql:host=' . $dbHost . ';dbname=' . $dbName, $dbUser, $dbPass);
$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
$db->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);

// Do the DB's checks
$incorrectUrl = false;
$currentUrl = "";

foreach($db->query('SELECT option_value FROM ' . $dbPrefix . 'options WHERE option_name="siteurl"') as $row) {
    if($row[0] !== $correctUrl) {
        $incorrectUrl = true;
        $currentUrl = $row[0];
        
        $sql = 'UPDATE ' . $dbPrefix . 'options SET option_value=? WHERE option_name="siteurl"';
        $stmt= $db->prepare($sql);
        $stmt->execute([$correctUrl]);
    }
}

foreach($db->query('SELECT option_value FROM ' . $dbPrefix . 'options WHERE option_name="home"') as $row) {
    if($row[0] !== $correctUrl) {
        $incorrectUrl = true;
        $currentUrl = $row[0];
        
        $sql = 'UPDATE ' . $dbPrefix . 'options SET option_value=? WHERE option_name="home"';
        $stmt= $db->prepare($sql);
        $stmt->execute([$correctUrl]);
    }
}

// Other custom fixes
if($incorrectUrl === true) {
    // ...

    // Clear WP Rocket cache
    if (function_exists('rocket_clean_domain')) {
        rocket_clean_domain();
    }

    // Clear Redis cache
    exec("redis-cli FLUSHALL");
    
    // Mail alert (might not always work)
    mail('contact@website.com', "A redirection has been fixed on the website", "A redirection has been fixed on the website ($currentUrl).");
}
